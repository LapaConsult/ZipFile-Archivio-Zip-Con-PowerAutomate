# ZipFile-Archivio-Zip-Con-PowerAutomate
> [!IMPORTANT]
>  al Feb 2024 non esiste un connettore standard in PowerAutomate per elaborare un archivio Zip
### Ci sono Sostanzialmente 2 metodi
1. [Creare una Funzione Azure da richiamare in PowerAutomate](https://www.damobird365.com/how-to-setup-an-azure-function-to-zip-files/) : Preferisco questa perche anche se a pagamento [potresti non pagare mai](https://azure.microsoft.com/en-us/pricing/details/functions/?ef_id=_k_CjwKCAiAiP2tBhBXEiwACslfngnkqM2FjwVhoYTkYoRoXCNvQb7FdA6gDGzWt5JfOayar4jP7EF49RoC724QAvD_BwE_k_&OCID=AIDcmmy6frl1tq_SEM__k_CjwKCAiAiP2tBhBXEiwACslfngnkqM2FjwVhoYTkYoRoXCNvQb7FdA6gDGzWt5JfOayar4jP7EF49RoC724QAvD_BwE_k_&gad_source=1&gclid=CjwKCAiAiP2tBhBXEiwACslfngnkqM2FjwVhoYTkYoRoXCNvQb7FdA6gDGzWt5JfOayar4jP7EF49RoC724QAvD_BwE )
2. [Usare una tattica Sharepoint](https://www.tachytelic.net/2021/07/power-automate-create-zip-file/) : Questa tattica usa il connettore standard HTTP Sharepoint in PowerAutomate quindi "Gratis"

> [!WARNING]
> Da notare pero che la dimensione dello zip non deve superare 200 MB se usi l'opzione 1 dell'azure Function e 100 mb se usi la seconda opzione HTTP Request di Sharepoint.

 ## 1. Azioni PowerAutomate metodo Azure Function ( da copiare in incollare dopo il trigger)
 ```
{"id":"463cf974-2050-493b-8f14-0635053be779","brandColor":"#8C3900","connectionReferences":{"shared_onedriveforbusiness":{"connection":{"id":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness/connections/0d2d1eb3993247bb9a5b21eba6e0e1b2"}},"shared_azureblob-5":{"connection":{"id":"/providers/Microsoft.PowerApps/apis/shared_azureblob/connections/shared-azureblob-dbb521d7-4766-4622-be86-2f251cc72f7b"}}},"connectorDisplayName":"Controllo","icon":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDMyIDMyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPg0KIDxwYXRoIGQ9Im0wIDBoMzJ2MzJoLTMyeiIgZmlsbD0iIzhDMzkwMCIvPg0KIDxwYXRoIGQ9Im04IDEwaDE2djEyaC0xNnptMTUgMTF2LTEwaC0xNHYxMHptLTItOHY2aC0xMHYtNnptLTEgNXYtNGgtOHY0eiIgZmlsbD0iI2ZmZiIvPg0KPC9zdmc+DQo=","isTrigger":false,"operationName":"Ambito","operationDefinition":{"type":"Scope","actions":{"Elenca_i_BLOB_(V2)":{"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_azureblob-5","operationId":"ListFolder_V4","apiId":"/providers/Microsoft.PowerApps/apis/shared_azureblob"},"parameters":{"dataset":"demoblobcreate","id":"JTJmZGVtb2NvbnRhaW5lcg==","nextPageMarker":"","useFlatListing":false},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}},"runAfter":{},"metadata":{"JTJmZGVtb2NvbnRhaW5lcg==":"/democontainer","operationMetadataId":"77a9ba69-b2ec-4f96-9eb0-9f98eba1eac5"}},"For_each":{"type":"Foreach","foreach":"@outputs('Elenca_i_BLOB_(V2)')?['body/value']","actions":{"Recupera_contenuto_BLOB_(V2)":{"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_azureblob-5","operationId":"GetFileContent_V2","apiId":"/providers/Microsoft.PowerApps/apis/shared_azureblob"},"parameters":{"dataset":"AccountNameFromSettings","id":"@items('For_each')?['Id']","inferContentType":false},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}},"runAfter":{"Componi_1":["Succeeded"]},"metadata":{"JTJmZGVtb2NvbnRhaW5lciUyZjEwMG1iX2ZpbGVfMS5iaW4=":"/democontainer/100mb_file_1.bin","operationMetadataId":"2fccb445-3593-4176-8e60-3d0baa4a4f99"}},"Componi_1":{"type":"Compose","inputs":"@items('For_each')?['Name']","runAfter":{},"metadata":{"operationMetadataId":"9ac87801-f798-42f6-b168-d8d17e59c149"}},"Componi":{"type":"Compose","inputs":{"FileName":"@{items('For_each')?['Name']}","FileContent":"@{base64(body('Recupera_contenuto_BLOB_(V2)')?['$content'])}"},"runAfter":{"Recupera_contenuto_BLOB_(V2)":["Succeeded"]},"metadata":{"operationMetadataId":"80d2cc39-9d85-4781-a966-82143279fcb4"}}},"runAfter":{"Elenca_i_BLOB_(V2)":["Succeeded"]},"metadata":{"operationMetadataId":"10abb2ff-1de1-4fa8-a2a0-461d5c9e6cb3"}},"HTTP":{"type":"Http","inputs":{"method":"POST","uri":"https://ariszipfiles.azurewebsites.net/api/ZipFiles?code=dEYTer0Z2_ucrTf0ou_dxtVo6mrGVxKcoPdDAIFGtY3_AzFuN4eFeg==","body":"@Outputs('Componi')"},"runAfter":{"For_each":["Succeeded"]},"metadata":{"operationMetadataId":"3b13bd37-ce5d-4687-927b-389cc5ae32e1"}},"Crea_file":{"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_onedriveforbusiness","operationId":"CreateFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness"},"parameters":{"folderPath":"/aZip_Demo/Zippato","name":"lapaconsult.zip","body":"@body('HTTP')"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}},"runAfter":{"HTTP":["Succeeded"]},"metadata":{"operationMetadataId":"e880187f-6a25-4868-97ef-1af95ebba995"}}},"runAfter":{},"metadata":{"operationMetadataId":"960e1418-1380-4ac0-bd9d-0837c4505697"}}}

```
## 2. Azioni PowerAutomate metodo Sharepoint HTTP ( da copiare in incollare dopo il trigger)
```
{"id":"b9007d35-b67d-4e79-91d2-33775efc4b78","brandColor":"#8C3900","connectionReferences":{"shared_onedriveforbusiness_1":{"connection":{"id":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness/connections/0d2d1eb3993247bb9a5b21eba6e0e1b2"}},"shared_sharepointonline_1":{"connection":{"id":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline/connections/49991ac50e464f028ace02bdfe23ecf0"}}},"connectorDisplayName":"Controllo","icon":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDMyIDMyIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPg0KIDxwYXRoIGQ9Im0wIDBoMzJ2MzJoLTMyeiIgZmlsbD0iIzhDMzkwMCIvPg0KIDxwYXRoIGQ9Im04IDEwaDE2djEyaC0xNnptMTUgMTF2LTEwaC0xNHYxMHptLTItOHY2aC0xMHYtNnptLTEgNXYtNGgtOHY0eiIgZmlsbD0iI2ZmZiIvPg0KPC9zdmc+DQo=","isTrigger":false,"operationName":"CreateZip","operationDefinition":{"type":"Scope","actions":{"accessToken":{"type":"Compose","inputs":"@outputs('SharePointHTTP')?['body']['ListSchema']['.driveAccessToken']","runAfter":{"SharePointHTTP":["Succeeded"]},"description":"Collects the Access Token required to access the files","metadata":{"operationMetadataId":"95000eaf-70ce-4139-9423-eb9e5da3ac73"}},"Select":{"type":"Select","inputs":{"from":"@body('SharePointHTTP')['ListData']['Row']","select":{"name":"@item()['FileLeafRef']","size":"@item()['SMTotalSize']","docId":"@{item()['.spItemUrl']}&@{outputs('accessToken')}","isFolder":"@if(equals(item()['FSObjType'], '1'), true, false)"}},"runAfter":{"accessToken":["Succeeded"]},"description":"Reformats the output of SharePoint HTTP action ready for submission to the Zip endpoint","metadata":{"operationMetadataId":"76d951fe-a751-4788-b0d1-5b941f0afe22"}},"Attachment_Items":{"type":"Compose","inputs":{"items":"@body('Select')"},"runAfter":{"Select":["Succeeded"]},"description":"Additional formatting of the Select array","metadata":{"operationMetadataId":"28312479-5603-46d1-ab8c-94ec659dc9a2"}},"downloadZip":{"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"HttpRequest","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"@body('SharePointHTTP')['ListSchema']['.mediaBaseUrl']","parameters/method":"POST","parameters/uri":"/transform/zip?cs=@{body('SharePointHTTP')['ListSchema']['.callerStack']}","parameters/headers":{"Content-Type":"application/x-www-form-urlencoded"},"parameters/body":"zipFileName=test.zip&guid=@{guid()}&provider=spo&files=@{encodeUriComponent(outputs('Attachment_Items'))}&oAuthToken="},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}},"runAfter":{"Attachment_Items":["Succeeded"]},"description":"Submits the request to the media server and downloads the Zip file","metadata":{"operationMetadataId":"7ee01a70-4b87-4cb3-975c-a9cf0e62a1d9"}},"StoreZip":{"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_onedriveforbusiness_1","operationId":"CreateFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_onedriveforbusiness"},"parameters":{"folderPath":"/aZip_Demo/Zippato","name":"testFile.zip","body":"@base64ToBinary(body('downloadZip')['$content'])"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}},"runAfter":{"downloadZip":["Succeeded"]},"description":"Stores the received Zip file in OneDrive","runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}},"metadata":{"operationMetadataId":"59060ffb-3aad-4582-ba2f-a5f0f210d633"}},"settings":{"type":"Compose","inputs":{"libraryPath":"/teams/digitalsei/Documenti condivisi","zipFolderPath":"/Annunci/FileDa_Zippare"},"runAfter":{},"description":"Imposta il collegamento ipertestuale alla libreria di documenti SharePoint che contiene i documenti da comprimere. Imposta zipFolderPath al percorso relativo della cartella che vuoi archiviare.","metadata":{"operationMetadataId":"7605dff6-dc27-446d-8882-d987fc52ff8b"}},"SharePointHTTP":{"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"HttpRequest","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://macraris.sharepoint.com/teams/digitalsei","parameters/method":"POST","parameters/uri":"_api/web/GetListUsingPath(DecodedUrl=@a1)/RenderListDataAsStream?@a1=%27@{encodeUriComponent(outputs('settings')['libraryPath'])}%27&RootFolder=@{encodeUriComponent(concat(outputs('settings')['libraryPath'], outputs('settings')['zipFolderPath']))}","parameters/body":"{\"parameters\": {\"RenderOptions\": 4103}}"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}},"runAfter":{"settings":["Succeeded"]},"description":"Retrieves the file and folder information required to create a Zip file","metadata":{"operationMetadataId":"68f9f9f2-bcbd-4523-b06e-ba57cebd8a7a"}},"Create_file":{"type":"OpenApiConnection","inputs":{"host":{"connectionName":"shared_sharepointonline_1","operationId":"CreateFile","apiId":"/providers/Microsoft.PowerApps/apis/shared_sharepointonline"},"parameters":{"dataset":"https://macraris.sharepoint.com/teams/digitalsei","folderPath":"/Documenti condivisi/Annunci/Zippato","name":"testZipFile.zip","body":"@base64ToBinary(body('downloadZip')['$content'])"},"authentication":{"type":"Raw","value":"@json(decodeBase64(triggerOutputs().headers['X-MS-APIM-Tokens']))['$ConnectionKey']"}},"runAfter":{"StoreZip":["Succeeded"]},"description":"Stores the received Zip file in a SharePoint document library","runtimeConfiguration":{"contentTransfer":{"transferMode":"Chunked"}},"metadata":{"operationMetadataId":"d4b06aeb-d34d-49e4-8f7c-2ee0bde04d85"}}},"runAfter":{},"description":"Un ambito per creare un file Zip in Power Automate senza l'uso di Connettori di Terze Parti o Azioni Premium","metadata":{"operationMetadataId":"675dbf7c-51b9-4f04-b8fc-0900cb8c8d2d"}}}
```
<a href="https://www.geeksforgeeks.org/" 
           target="blank">here 
        </a> to visit GeeksForGeeks website. 
